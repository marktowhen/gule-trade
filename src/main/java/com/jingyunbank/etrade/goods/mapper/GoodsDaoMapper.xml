<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper 
	PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.jingyunbank.etrade.goods.dao.GoodsDao">
	<!-- 封装商品信息Map -->
	<resultMap type="com.jingyunbank.etrade.goods.entity.GoodsDaoEntity"
		id="baseGoodsMap">
		<!-- 商品概要信息 -->
		<result column="gid" property="GID" />
		<result column="goodsname" property="goodsName" />
		<result column="weight" property="weight" />
		<result column="unit" property="unit" />
		<result column="price" property="price" />
		<result column="promotion_price" property="promotion_price" />
		<result column="nowprice" property="nowPrice" />
		<result column="pro_flag" property="pro_flag" />
		<result column="pro_start" property="pro_start" />
		<result column="pro_end" property="pro_end" />
		<!-- 商品图片信息 -->
		<result column="thumb_path_1" property="thumb_path_1" />
		<!-- 店铺信息 -->
		<result column="mid" property="MID" />
		<result column="merchantname" property="merchantName" />
		<result column="merchantdesc" property="merchantDesc" />
		<result column="merchantimg" property="merchantImg" />
		<!-- 品牌信息 -->
		<result column="bid" property="BID" />
		<result column="brandname" property="brandName" />
		<result column="branddesc" property="brandDesc" />
		<!--类型信息 -->
		<result column="tid" property="TID" />
		<result column="typename" property="typeName" />
	</resultMap>
	<!-- 商品条件关联的店铺信息 -->
	<resultMap type="com.jingyunbank.etrade.goods.entity.GoodsMerchantEntity"
		id="GoodsMerchantMap">
		<result column="mid" property="MID" />
		<result column="merchantname" property="merchantName" />
		<result column="merchantbrands" property="merchantBrands" />
		<result column="m_img" property="merchantImg" />
		<result column="m_desc" property="merchantDesc" />
		<result column="counts" property="goodscount" />
	</resultMap>
	<!-- 查询热门推荐商品的基本信息 -->
	<resultMap type="com.jingyunbank.etrade.goods.entity.HotGoodsEntity"
		id="hotGoodsEntity">
		<!-- 商品概要信息 -->
		<result column="gid" property="GID" />
		<result column="goodsname" property="goodsName" />
		<result column="weight" property="weight" />
		<result column="unit" property="unit" />
		<result column="price" property="price" />
		<result column="price" property="price" />
		<result column="special_price" property="specialPrice" />
		<result column="nowprice" property="nowPrice" />
		<result column="thumb_path_1" property="thumb_path_1" />
		<!-- 品牌信息 -->
		<result column="bid" property="BID" />
		<result column="brandname" property="brandName" />
		<result column="branddesc" property="brandDesc" />
		<!--类型信息 -->
		<result column="tid" property="TID" />
		<result column="typename" property="typeName" />
	</resultMap>

	<!-- 商品图片属性 goods_img i -->
	<sql id="imgAttr">
		i.Thumb_path_1 thumb_path_1,
		i.Thumb_path_2 thumb_path_2,
		i.Thumb_path_3 thumb_path_3,
		i.Thumb_path_4 thumb_path_4,
		i.show_path_1, show_path_1,
		i.show_path_2, show_path_2,
		i.show_path_3,
		show_path_3,
		i.show_path_4, show_path_4,
	</sql>
	
	<!-- 根据促销标志算出当然价格 -->
	<sql id="nowprice">
		CASE g.pro_flag WHEN '1' THEN g.promotion_price WHEN '0'  THEN g.price ELSE g.price END AS nowprice,
	</sql>
	<!-- 商品概要信息查询字段 -->
	<sql id="commentGoods">
		g.id gid, g.name goodsname,d.weight weight,d.unit
		unit,g.price price ,g.promotion_price promotion_price,
		<include refid="nowprice"/>
		i.Thumb_path_1 thumb_path_1,g.volume volume,g.addtime addtimes,
		g.pro_flag pro_flag, g.pro_start pro_start, g.pro_end pro_end
	</sql>

	<!-- 根据名称like查询商品 -->
	<select id="selectGoodsByLikeName" parameterType="java.util.Map"
		resultMap="baseGoodsMap">
		SELECT
		<include refid="commentGoods" />
		FROM GOODS g
		LEFT JOIN goods_detail d ON g.id=d.gid
		LEFT JOIN goods_img
		i ON g.id = i.gid
		WHERE 1 = 1 AND g.state=1 AND g.name LIKE
		CONCAT(CONCAT('%', #{goodsname}), '%')
		LIMIT #{from} , #{size}
	</select>

	<!-- 查询品牌 -->
	<select id="selectBrands" resultMap="baseGoodsMap">
		SELECT b.id bid, b.name
		brandname, b.desc branddesc FROM goods_brand b ORDER BY b.admin_sort
	</select>
	<!-- 查询类型 -->
	<select id="selectTypes" resultMap="baseGoodsMap">
		SELECT t.id tid,t.name
		typename FROM goods_type t
	</select>



	<!-- 查询热门推荐商品 -->
	<sql id="hotGoodsWhere">
		g.id,g.mid, b.id brand_id ,b.name brand_name,p.name type_name,g.name,
		g.price,g.now_price now_price , g.count count, g.volume volume
		,g.addtime addtime,
		<include refid="imgAttr" />
		d.weight,d.unit ,t.strategy_name,t.parameter1
	</sql>


	<!-- 根据查询条件查询商品 -->
	<select id="selectGoodsByWhere" parameterType="java.util.Map"
		resultMap="baseGoodsMap">
		SELECT
		<include refid="commentGoods" />
		FROM goods g
		LEFT JOIN goods_detail d ON d.gid = g.id
		LEFT JOIN
		goods_img i ON i.gid=g.id
		WHERE 1=1 AND g.state=1
		<if test="brandArr !='' and brandArr !=null ">
			AND g.bid IN
			<foreach collection="brandArr" index="index" item="item"
				open="(" separator="," close=")">
				#{item}
			</foreach>
		</if>
		<if test="typeArr !='' and typeArr !=null ">
			AND g.tid IN
			<foreach collection="typeArr" index="index" item="item" open="("
				separator="," close=")">
				#{item}
			</foreach>
		</if>

		<if test="beginprice !=''">
			<![CDATA[ AND (CASE g.pro_flag WHEN '1' THEN g.promotion_price WHEN '0'  THEN g.price ELSE g.price END) >= #{beginprice} ]]>
		</if>
		<if test="endprice !=''">
			<![CDATA[ AND (CASE g.pro_flag WHEN '1' THEN g.promotion_price WHEN '0'  THEN g.price ELSE g.price END) <= #{endprice} ]]>
		</if>
		<!-- 销量排序 -->
		<if test="order ==1 ">
			ORDER BY g.volume DESC
		</if>
		<!-- 价格排序 -->
		<if test="order ==2 ">
			ORDER BY nowprice 
		</if>
		<!-- 评论数排序 -->
		<if test="order ==3 ">
			<!-- 目前还没有评论功能 ORDER BY g.volume DESC -->
		</if>
		<!-- 新品排序 -->
		<if test="order ==4 ">
			ORDER BY g.addtime DESC
		</if>
		LIMIT #{from} , #{size}
	</select>

	<!-- 查询首页热门推荐商品列表（准备添加热门推荐排序，以后所有排序均由管理员统一配置维护） 该语句需要修改 -->
	<select id="selectHotGoods" resultMap="hotGoodsEntity">
		SELECT
		<include refid="hotGoodsWhere" />
	<![CDATA[
	FROM (
		select x.*
		FROM goods x
		 where 1=1 AND x.state=1
		 and x.mid in (select id from merchant m where m.admin_sort_num <=5) 
		 and (select count(*) 
		     from goods t
		     where x.mid = t.mid and t.volume > x.volume and x.state=1 ) <= 4
		) g
		LEFT JOIN goods_detail d ON g.id=d.gid
		LEFT JOIN goods_strategy s ON g.id=s.gid
		LEFT JOIN strategy t ON s.sid=t.id
		LEFT JOIN goods_brand b ON b.id=g.bid
		LEFT JOIN goods_img i ON g.id=i.gid
		LEFT JOIN goods_type p ON p.id = g.tid where 1=1 AND g.state=1
		ORDER BY g.volume DESC
		 ]]>
	</select>
	<!-- 根据商品 推荐序号 查询 宝贝推荐的商品 -->
	<select id="selectRecommend" resultMap="baseGoodsMap">
		SELECT g.id gid,g.name
		goodsname, m.merchant_name merchantname, i.Thumb_path_1 thumb_path_1
		FROM goods g
		LEFT JOIN merchant m ON g.mid=m.id
		LEFT JOIN goods_img i ON
		i.gid = g.id
		WHERE g.record_sort IS NOT NULL
		ORDER BY g.record_sort
	</select>
	<!-- 根据商品条件搜索关联店铺 -->
	<select id="selectMerchantByWhere" parameterType="java.util.Map"
		resultMap="GoodsMerchantMap">
		SELECT m.`id` mid ,m.`merchant_name` merchantname,m.img_path m_img, <include refid="nowprice"/>
		m.merchant_desc m_desc, COUNT(g.id) counts FROM goods g
		LEFT JOIN
		goods_detail d ON d.gid = g.id
		LEFT JOIN goods_img i ON i.gid = g.id
		LEFT JOIN merchant m ON m.id=g.mid
		LEFT JOIN goods_brand b ON
		b.id=g.`bid`
		LEFT JOIN goods_type t ON t.id=g.tid
		WHERE 1=1 AND
		g.state=1
		<if test="brandArr !='' and brandArr !=null ">
			AND g.bid IN
			<foreach collection="brandArr" index="index" item="item"
				open="(" separator="," close=")">
				#{item}
			</foreach>
		</if>
		<if test="typeArr !='' and typeArr !=null ">
			AND g.tid IN
			<foreach collection="typeArr" index="index" item="item" open="("
				separator="," close=")">
				#{item}
			</foreach>
		</if>

		<if test="beginprice !=''">
			<![CDATA[ AND (CASE g.pro_flag WHEN '1' THEN g.promotion_price WHEN '0'  THEN g.price ELSE g.price END) >= #{beginprice} ]]>
		</if>
		<if test="endprice !=''">
			<![CDATA[ AND (CASE g.pro_flag WHEN '1' THEN g.promotion_price WHEN '0'  THEN g.price ELSE g.price END) <= #{endprice} ]]>
		</if>
		GROUP BY merchantname LIMIT #{from} , #{size}
	</select>
	<!-- 查询店铺相关产品 -->
	<select id="selectMerchantByWhereGoods" parameterType="java.util.Map"
		resultMap="baseGoodsMap">
		SELECT
		<include refid="commentGoods" />
		FROM goods g
		LEFT JOIN goods_detail d ON d.gid = g.id
		LEFT JOIN goods_img i ON i.gid =
		g.id
		LEFT JOIN merchant m ON m.id=g.mid
		LEFT JOIN goods_brand b ON
		b.id=g.`bid`
		LEFT JOIN goods_type t ON t.id=g.tid
		WHERE 1=1 AND
		g.state=1 AND m.id = #{mid}
		<if test="brandArr !='' and brandArr !=null ">
			AND g.bid IN
			<foreach collection="brandArr" index="index" item="item"
				open="(" separator="," close=")">
				#{item}
			</foreach>
		</if>
		<if test="typeArr !='' and typeArr !=null ">
			AND g.tid IN
			<foreach collection="typeArr" index="index" item="item" open="("
				separator="," close=")">
				#{item}
			</foreach>
		</if>

		<if test="beginprice !=''">
			<![CDATA[ AND (CASE g.pro_flag WHEN '1' THEN g.promotion_price WHEN '0'  THEN g.price ELSE g.price END) >= #{beginprice} ]]>
		</if>
		<if test="endprice !=''">
			<![CDATA[ AND (CASE g.pro_flag WHEN '1' THEN g.promotion_price WHEN '0'  THEN g.price ELSE g.price END) <= #{endprice} ]]>
		</if>
	</select>
	<!-- 查询热门推荐商品的基本信息 -->
	<resultMap type="com.jingyunbank.etrade.goods.entity.Hot24GoodsEntity"
		id="hot24GoodsEntity">
		<!-- 商品概要信息 -->
		<result column="id" property="GID" />
		<result column="name" property="goodsName" />
		<result column="price" property="price" />
		<result column="now_price" property="nowPrice" />
		<result column="thumb_path_1" property="thumb_path_1" />
	</resultMap>
	<!-- 查询24小时热卖推荐商品列表 -->
	<select id="selectHot24Goods" resultMap="hot24GoodsEntity">
		SELECT
		x.id,x.mid,x.name,x.price,x.now_price now_price,i.thumb_path_1 as thumb_path_1
	<![CDATA[
	 from (
		select gid,sum(count) as count from tran_records where 
		turnover_date  >= 
		DATE_SUB(NOW(),INTERVAL 24 HOUR)
		group by gid order by sum(count) desc limit 0,3
		) r left join goods x
		 on 1=1 AND x.state=1
		and r.gid = x.id
		left join goods_img i
	    on r.gid = i.gid 
		 ]]>
	</select>
	<!-- 查询推广商品 -->
	<select id="selectGoodsExpand" resultMap="baseGoodsMap">
		SELECT
		<include refid="commentGoods" />
		FROM goods g
		LEFT JOIN goods_img i ON g.id=i.gid
		LEFT JOIN goods_detail d ON g.id=d.gid
		WHERE expand_sort IS NOT NULL ORDER BY expand_sort
	</select>
	<!-- 我的足迹商品信息 -->
	<resultMap type="com.jingyunbank.etrade.goods.entity.FootprintGoodsEntity" id="selectFootprintGoods">
		<result column="visit_time" property="visitTime" javaType="java.util.Date"/>
		<result column="gid" property="GID"/>
		<result column="name" property="goodsName"/>
		<result column="price" property="price"/>
		<result column="now_price" property="nowPrice"/>
		<result column="thumb_path_1" property="thumb_path_1"/>
	</resultMap>
	<!-- 查询我的足迹商品列表 　 -->
	<select id="selectFootprintGoods"  resultMap="selectFootprintGoods">
	SELECT 
	*
	<![CDATA[
			 from (
		select uid,gid,MAX(visit_time) as visit_time 
		from footprint
		where uid = '1'
		group by uid,gid
		ORDER BY visit_time desc
		) v inner join goods x
		 on 1=1 AND x.state=1
		and v.gid = x.id
		left join goods_img i
	    on v.gid = i.gid 
		 ]]>
	</select>
</mapper>
